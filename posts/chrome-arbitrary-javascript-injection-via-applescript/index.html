<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Chrome Arbitrary Javascript Injection Via AppleScript" /><meta name="author" content="noncetonic" /><meta property="og:locale" content="en" /><meta name="description" content="Foreword I’ve had a PoC for this technique for a little while as part of research for a future talk on the subject of post-exploitation in MacOS, but as an article has surfaced detailing the adware OSX.Pirrit’s use of this technique, I thought it appropriate to disclose this writeup. It should be noted that while this particular PoC targets only Google Chrome, the attack works against Safari as well. Mozilla Firefox is exempt from this specific attack as they do not expose a similar scripting definition to AppleScript." /><meta property="og:description" content="Foreword I’ve had a PoC for this technique for a little while as part of research for a future talk on the subject of post-exploitation in MacOS, but as an article has surfaced detailing the adware OSX.Pirrit’s use of this technique, I thought it appropriate to disclose this writeup. It should be noted that while this particular PoC targets only Google Chrome, the attack works against Safari as well. Mozilla Firefox is exempt from this specific attack as they do not expose a similar scripting definition to AppleScript." /><link rel="canonical" href="https://blacksunhackers.club/posts/chrome-arbitrary-javascript-injection-via-applescript/" /><meta property="og:url" content="https://blacksunhackers.club/posts/chrome-arbitrary-javascript-injection-via-applescript/" /><meta property="og:site_name" content="Blacksun Hackers Club" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-12-13T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Chrome Arbitrary Javascript Injection Via AppleScript" /><meta name="twitter:site" content="@BlacksunLabs_" /><meta name="twitter:creator" content="@https://twitter.com/noncetonic" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"noncetonic"},"description":"Foreword I’ve had a PoC for this technique for a little while as part of research for a future talk on the subject of post-exploitation in MacOS, but as an article has surfaced detailing the adware OSX.Pirrit’s use of this technique, I thought it appropriate to disclose this writeup. It should be noted that while this particular PoC targets only Google Chrome, the attack works against Safari as well. Mozilla Firefox is exempt from this specific attack as they do not expose a similar scripting definition to AppleScript.","url":"https://blacksunhackers.club/posts/chrome-arbitrary-javascript-injection-via-applescript/","@type":"BlogPosting","headline":"Chrome Arbitrary Javascript Injection Via AppleScript","dateModified":"2021-09-12T03:17:07+08:00","datePublished":"2017-12-13T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blacksunhackers.club/posts/chrome-arbitrary-javascript-injection-via-applescript/"},"@context":"https://schema.org"}</script><title>Chrome Arbitrary Javascript Injection Via AppleScript | Blacksun Hackers Club</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Blacksun Hackers Club"><meta name="application-name" content="Blacksun Hackers Club"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/bsh_logo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Blacksun Hackers Club</a></div><div class="site-subtitle font-italic">Just a bunch of hackers doing what we find fun.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/BlacksunLabs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/BlacksunLabs_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Chrome Arbitrary Javascript Injection Via AppleScript</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Chrome Arbitrary Javascript Injection Via AppleScript</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Written by <a href=https://twitter.com/noncetonic> <b>noncetonic</b> </a> </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 13, 2017, 12:00 AM +0800" >Dec 13, 2017<i class="unloaded">2017-12-13T00:00:00+08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 11, 2021, 12:17 PM -0700" >Sep 11, 2021<i class="unloaded">2021-09-12T03:17:07+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="534 words">2 min read</span></div></div><div class="post-content"><h2 id="foreword">Foreword</h2><p>I’ve had a PoC for this technique for a little while as part of research for a future talk on the subject of post-exploitation in MacOS, but as an article has surfaced <a href="https://www.cybereason.com/blog/targetingedge-mac-os-x-pirrit-malware-adware-still-active">detailing the adware OSX.Pirrit</a>’s use of this technique, I thought it appropriate to disclose this writeup. It should be noted that while this particular PoC targets only Google Chrome, the attack works against Safari as well. Mozilla Firefox is exempt from this specific attack as they do not expose a similar scripting definition to AppleScript.</p><h2 id="browser-hijacks-are-hard-lets-go-shopping">Browser hijacks are hard, let’s go shopping</h2><p>Wouldn’t it be nice to inject arbitrary Javascript into a user’s browser regardless of XSS detection, website, or hoping a user is foolish enough to visit a BeEF link?</p><p>Sniffing credentials right out of form submissions, disregarding 2FA by leveraging a victim’s already active tab, redressing/overlay attacks and much more are possible with this technique, and all done with no specialized tools.</p><p>Join me as I rush to release this post before everyone writes detection around this surprisingly well documented feature of Chrome/Safari on MacOS and create a mostly harmless inject which sneakily scrapes a Gmail tab for Email, Sender name, and Subject informatino leveraging Applescript as an In-Memory Javascript Injector</p><h2 id="has-anyone-really-ever-been-as-far-as-to-do-want-inject-javascript">Has anyone really ever been as far as to do want inject javascript?</h2><h3 id="the-poc">The PoC</h3><p>You probably don’t care about the how and just want a pre-packed PoC ready to be used for rickrolling your friends so here it is:</p><p>Full Chrome Gmail Javascript Injection AppleScript <script src="https://gist.github.com/n0ncetonic/aa4a523d01c822953d0d0cb50d5ac7c0.js?file=Chrome_Gmail_Javascript_Injection.applescript"></script></p><p>Non-Minified Javascript payload <script src="https://gist.github.com/n0ncetonic/aa4a523d01c822953d0d0cb50d5ac7c0.js?file=chrome_arbitrary_javascript_injection_PoC.js"></script></p><p>Minimized OSAScript oneliner <script src="https://gist.github.com/n0ncetonic/aa4a523d01c822953d0d0cb50d5ac7c0.js?file=minified_osascript_payload.sh"></script></p><p>Minified Javascript payload (keeps size of Applescript payload/oneliner small) <script src="https://gist.github.com/n0ncetonic/aa4a523d01c822953d0d0cb50d5ac7c0.js?file=minified_chrome_arbitrary_javascript_injection_PoC.js"></script></p><h3 id="how-the-whut">How the whut?</h3><p>Put simply, AppleScript is boss and very few built-in scripting languages on other Operating Systems come close to the amount of power that given to end-users and developers. Intended primarily to be used for automation, AppleScript has the potential to open the door to a lot of fun for system administrators and hackers alike.</p><p>Applications with dedicated integrations with AppleScript contain an <code class="language-plaintext highlighter-rouge">.sdef</code> file which outlines the _S_cripting _Def_initions available to AppleScript. Poking around a bit on my system I noticed that Chrome and Safari had .sdef files.</p><p><a href="https://chromium.googlesource.com/chromium/src.git/+/master/chrome/browser/ui/cocoa/applescript/scripting.sdef">Here’s a link to Chrome’s for those who want to follow along</a> For a little more fun <a href="https://chromium.googlesource.com/chromium/src.git/+/master/chrome/browser/ui/cocoa/applescript/examples/execute_javascript.applescript">Here is an example provided by Google themselves on executing Javascript in the browser</a></p><p>Writing a little bit of AppleScript to take advantage of this feature and leveraging a <a href="http://jsbeautifier.org/">Javascript minimizer</a> to keep the size of the payload small results in a really fun little browser hijack technique.</p><h3 id="whats-it-do">What’s it do?</h3><p>While a primer on AppleScript is outside the scope of this post, a quick breakdown of the code is provided as comments in the provided code to aid the reader.</p><p>RTFM</p><h2 id="closing">Closing</h2><p>While I’m sad that I wasn’t the first one to weaponize this technique publicly I hope that this public release of a fairly harmless PoC will spark discussion around writing more creative payloads and help excite malware authors and security researchers to take more time to look at MacOS and develop more post-exploitation techniques.</p><p>I leave implementation of this PoC in Safari as an exercise for the reader.</p><p>RIP Trevor; another fun bug squashed in public.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/macos/" class="post-tag no-text-decoration" >MacOS</a> <a href="/tags/post-exploitation/" class="post-tag no-text-decoration" >Post-Exploitation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Chrome Arbitrary Javascript Injection Via AppleScript - Blacksun Hackers Club&url=https://blacksunhackers.club/posts/chrome-arbitrary-javascript-injection-via-applescript/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Chrome Arbitrary Javascript Injection Via AppleScript - Blacksun Hackers Club&u=https://blacksunhackers.club/posts/chrome-arbitrary-javascript-injection-via-applescript/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Chrome Arbitrary Javascript Injection Via AppleScript - Blacksun Hackers Club&url=https://blacksunhackers.club/posts/chrome-arbitrary-javascript-injection-via-applescript/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Bypassing-TCC-With-iTerm2/">Bypassing TCC With iTerm2</a><li><a href="/posts/acquiring-and-abusing-legacy-slack-tokens/">Acquiring and Abusing Slack Legacy Tokens on macOS</a><li><a href="/posts/macOS-serial-console-login/">macOS Serial Console Login</a><li><a href="/posts/cultivating-an-online-persona-1/">Cultivating An Online Persona Part 1 - Bypassing Gmail's Phone Verification</a><li><a href="/posts/post-exploitation-persistence-with-application-shims-intro/">Post Exploitation Persistence With Application Shims (Intro)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/post-exploitation/">Post-Exploitation</a> <a class="post-tag" href="/tags/persistence/">Persistence</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/fingerprinting/">Fingerprinting</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/osint/">OSINT</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/macOS-serial-console-login/"><div class="card-body"> <span class="timeago small" >Nov 18, 2018<i class="unloaded">2018-11-18T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>macOS Serial Console Login</h3><div class="text-muted small"><p> Foreword This short post documents a technique for authenticating as root on macOS and provides procedures for bypassing the default configuration of macOS which explicitly disables the root user. ...</p></div></div></a></div><div class="card"> <a href="/posts/iCloud-Authentication-Token-acquisition-on-macOS/"><div class="card-body"> <span class="timeago small" >Mar 13, 2019<i class="unloaded">2019-03-13T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iCloud Authentication Token acquisition on macOS</h3><div class="text-muted small"><p> Foreward While this is by no means new or groundbreaking information I’ve been meaning to document a process known to the forensic and law enforcement community and provided as part of point-and-cl...</p></div></div></a></div><div class="card"> <a href="/posts/acquiring-and-abusing-legacy-slack-tokens/"><div class="card-body"> <span class="timeago small" >Mar 18, 2019<i class="unloaded">2019-03-18T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Acquiring and Abusing Slack Legacy Tokens on macOS</h3><div class="text-muted small"><p> Foreward Right on the tails of my last post that detailed a token theft attack on macOS, today I’m sharing yet another procedure for acquiring and abusing tokens found on a macOS system. Included...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cultivating-an-online-persona-1/" class="btn btn-outline-primary" prompt="Older"><p>Cultivating An Online Persona Part 1 - Bypassing Gmail's Phone Verification</p></a> <a href="/posts/macOS-serial-console-login/" class="btn btn-outline-primary" prompt="Newer"><p>macOS Serial Console Login</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/BlacksunLabs_">Blacksun Labs</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/post-exploitation/">Post Exploitation</a> <a class="post-tag" href="/tags/persistence/">Persistence</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/fingerprinting/">Fingerprinting</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/osint/">OSINT</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://blacksunhackers.club{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
