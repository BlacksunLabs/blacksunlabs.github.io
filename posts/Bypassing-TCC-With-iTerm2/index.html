<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Bypassing TCC With iTerm2" /><meta name="author" content="actae0n" /><meta property="og:locale" content="en" /><meta name="description" content="Motivation When landing a shell in MacOS environments, you’ll frequently want access to the files under your victim’s home folder. Some of these locations are TCC protected. Specifically ~/Documents/, ~/Downloads/, ~/Desktop/ all require their own approvals which correspond to the kTCCServiceSystemPolicyDocumentsFolder, kTCCServiceSystemPolicyDownloadsFolder, kTCCServiceSystemPolicyDesktopFolder service categories respectively. Depending on how you landed your initial access, you may not have the necessary TCC approvals. If your target has iTerm2 installed and they use it for day-to-day work, you may have a simple way around these TCC restrictions." /><meta property="og:description" content="Motivation When landing a shell in MacOS environments, you’ll frequently want access to the files under your victim’s home folder. Some of these locations are TCC protected. Specifically ~/Documents/, ~/Downloads/, ~/Desktop/ all require their own approvals which correspond to the kTCCServiceSystemPolicyDocumentsFolder, kTCCServiceSystemPolicyDownloadsFolder, kTCCServiceSystemPolicyDesktopFolder service categories respectively. Depending on how you landed your initial access, you may not have the necessary TCC approvals. If your target has iTerm2 installed and they use it for day-to-day work, you may have a simple way around these TCC restrictions." /><link rel="canonical" href="https://blacksunhackers.club/posts/Bypassing-TCC-With-iTerm2/" /><meta property="og:url" content="https://blacksunhackers.club/posts/Bypassing-TCC-With-iTerm2/" /><meta property="og:site_name" content="Blacksun Hackers Club" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-08T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Bypassing TCC With iTerm2" /><meta name="twitter:site" content="@BlacksunLabs_" /><meta name="twitter:creator" content="@https://twitter.com/actae0n" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"actae0n"},"description":"Motivation When landing a shell in MacOS environments, you’ll frequently want access to the files under your victim’s home folder. Some of these locations are TCC protected. Specifically ~/Documents/, ~/Downloads/, ~/Desktop/ all require their own approvals which correspond to the kTCCServiceSystemPolicyDocumentsFolder, kTCCServiceSystemPolicyDownloadsFolder, kTCCServiceSystemPolicyDesktopFolder service categories respectively. Depending on how you landed your initial access, you may not have the necessary TCC approvals. If your target has iTerm2 installed and they use it for day-to-day work, you may have a simple way around these TCC restrictions.","url":"https://blacksunhackers.club/posts/Bypassing-TCC-With-iTerm2/","@type":"BlogPosting","headline":"Bypassing TCC With iTerm2","dateModified":"2021-12-09T13:40:57+08:00","datePublished":"2021-12-08T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blacksunhackers.club/posts/Bypassing-TCC-With-iTerm2/"},"@context":"https://schema.org"}</script><title>Bypassing TCC With iTerm2 | Blacksun Hackers Club</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Blacksun Hackers Club"><meta name="application-name" content="Blacksun Hackers Club"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/bsh_logo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Blacksun Hackers Club</a></div><div class="site-subtitle font-italic">Just a bunch of hackers doing what we find fun.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/BlacksunLabs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/BlacksunLabs_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Bypassing TCC With iTerm2</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Bypassing TCC With iTerm2</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Written by <a href=https://twitter.com/actae0n> <b>actae0n</b> </a> </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 8, 2021, 12:00 AM +0800" >Dec 8, 2021<i class="unloaded">2021-12-08T00:00:00+08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 8, 2021, 9:40 PM -0800" >Dec 8, 2021<i class="unloaded">2021-12-09T13:40:57+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="289 words">1 min read</span></div></div><div class="post-content"><h1 id="motivation">Motivation</h1><p>When landing a shell in MacOS environments, you’ll frequently want access to the files under your victim’s home folder. Some of these locations are TCC protected. Specifically <code class="language-plaintext highlighter-rouge">~/Documents/</code>, <code class="language-plaintext highlighter-rouge">~/Downloads/</code>, <code class="language-plaintext highlighter-rouge">~/Desktop/</code> all require their own approvals which correspond to the <code class="language-plaintext highlighter-rouge">kTCCServiceSystemPolicyDocumentsFolder</code>, <code class="language-plaintext highlighter-rouge">kTCCServiceSystemPolicyDownloadsFolder</code>, <code class="language-plaintext highlighter-rouge">kTCCServiceSystemPolicyDesktopFolder</code> service categories respectively. Depending on how you landed your initial access, you may not have the necessary TCC approvals. If your target has iTerm2 installed and they use it for day-to-day work, you may have a simple way around these TCC restrictions.</p><h1 id="iterm2-autolaunch-scripts">iTerm2 AutoLaunch Scripts</h1><p>iTerm2 has support for autolaunching an AppleScript file at startup, if it’s placed at a predetermined path, as documented <a href="https://iterm2.com/documentation-scripting.html">here</a>. This technique was also discussed for persistence purposes by noncetonic in <a href="/posts/macOS-persistence-via-iterm/">this post</a>. Internally, this is done programmatically using <a href="https://developer.apple.com/documentation/foundation/nsuserapplescripttask?language=objc">NSUserAppleScriptTask</a>.</p><h1 id="the-vulnerability">The Vulnerability</h1><p>This allows us to have iTerm2 send AppleEvents to itself (or other applications) to do things on our behalf. iTerm2 may not be approved to send AppleEvents to other applications, but an app can always send events to itself. So, anything iTerm2 is approved via TCC to do, we are also approved to do.</p><p>We can craft an <code class="language-plaintext highlighter-rouge">AutoLaunch.scpt</code> that asks iTerm2 to exfiltrate the contents of protected directories like <code class="language-plaintext highlighter-rouge">~/Documents</code>, <code class="language-plaintext highlighter-rouge">~/Downloads</code>, and <code class="language-plaintext highlighter-rouge">~/Desktop</code> when the user launches iTerm2 to a directory that we have full read access to.</p><h1 id="simple-proof-of-concept">Simple Proof of Concept</h1><p>Write the following contents to <code class="language-plaintext highlighter-rouge">~/Library/Application Support/iTerm2/Scripts/AutoLaunch.scpt</code>.</p><div lang="applescript" class="language-applescript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">-- ~/Library/Application Support/iTerm2/Scripts/AutoLaunch.scpt</span><span class="w">
</span><span class="k">tell</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"iTerm"</span><span class="w">
    </span><span class="nb">do shell script</span><span class="w"> </span><span class="s2">"cp -R ~/Documents/ /tmp/"</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">tell</span><span class="w">
</span></pre></table></code></div></div><p><img data-proofer-ignore data-src="/images/iterm_tcc.png" alt="Bypass in Action" /></p><h1 id="caveats">Caveats</h1><p>An important note is that <code class="language-plaintext highlighter-rouge">AutoLaunch.scpt</code> is only executed when iTerm2 first starts up. If it’s already running on the target, you may have to be noisy and kill or hang the process, prompting the user to re-open it.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/macos/" class="post-tag no-text-decoration" >MacOS</a> <a href="/tags/post-exploitation/" class="post-tag no-text-decoration" >Post-Exploitation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bypassing TCC With iTerm2 - Blacksun Hackers Club&url=https://blacksunhackers.club/posts/Bypassing-TCC-With-iTerm2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bypassing TCC With iTerm2 - Blacksun Hackers Club&u=https://blacksunhackers.club/posts/Bypassing-TCC-With-iTerm2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Bypassing TCC With iTerm2 - Blacksun Hackers Club&url=https://blacksunhackers.club/posts/Bypassing-TCC-With-iTerm2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Bypassing-TCC-With-iTerm2/">Bypassing TCC With iTerm2</a><li><a href="/posts/acquiring-and-abusing-legacy-slack-tokens/">Acquiring and Abusing Slack Legacy Tokens on macOS</a><li><a href="/posts/macOS-serial-console-login/">macOS Serial Console Login</a><li><a href="/posts/cultivating-an-online-persona-1/">Cultivating An Online Persona Part 1 - Bypassing Gmail's Phone Verification</a><li><a href="/posts/post-exploitation-persistence-with-application-shims-intro/">Post Exploitation Persistence With Application Shims (Intro)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/post-exploitation/">Post-Exploitation</a> <a class="post-tag" href="/tags/persistence/">Persistence</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/fingerprinting/">Fingerprinting</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/osint/">OSINT</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/chrome-arbitrary-javascript-injection-via-applescript/"><div class="card-body"> <span class="timeago small" >Dec 13, 2017<i class="unloaded">2017-12-13T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Chrome Arbitrary Javascript Injection Via AppleScript</h3><div class="text-muted small"><p> Foreword I’ve had a PoC for this technique for a little while as part of research for a future talk on the subject of post-exploitation in MacOS, but as an article has surfaced detailing the adware...</p></div></div></a></div><div class="card"> <a href="/posts/macOS-serial-console-login/"><div class="card-body"> <span class="timeago small" >Nov 18, 2018<i class="unloaded">2018-11-18T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>macOS Serial Console Login</h3><div class="text-muted small"><p> Foreword This short post documents a technique for authenticating as root on macOS and provides procedures for bypassing the default configuration of macOS which explicitly disables the root user. ...</p></div></div></a></div><div class="card"> <a href="/posts/iCloud-Authentication-Token-acquisition-on-macOS/"><div class="card-body"> <span class="timeago small" >Mar 13, 2019<i class="unloaded">2019-03-13T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iCloud Authentication Token acquisition on macOS</h3><div class="text-muted small"><p> Foreward While this is by no means new or groundbreaking information I’ve been meaning to document a process known to the forensic and law enforcement community and provided as part of point-and-cl...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Looting-Electron-Apps-Via-V8-Inspector/" class="btn btn-outline-primary" prompt="Older"><p>Looting Electron Apps Via The V8 Inspector</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/BlacksunLabs_">Blacksun Labs</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/post-exploitation/">Post Exploitation</a> <a class="post-tag" href="/tags/persistence/">Persistence</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/fingerprinting/">Fingerprinting</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/osint/">OSINT</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://blacksunhackers.club{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
